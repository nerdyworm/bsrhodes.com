<!DOCTYPE html> 
<html> 
<head> 
  <title>Rails Bookmarklets without jQuery</title> 
  <link href="/css/960.css" media="screen" rel="stylesheet" type="text/css"/> 
  <link href="/css/screen.css" media="screen" rel="stylesheet" type="text/css"/> 
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.2.6/jquery.min.js"></script> 
  <script type="text/javascript" src="/js/fancyzoom.js"></script> 
</head> 
<body style="background: #111"> 
  
  <header id="site" class="group"> 
    <div class="container_10 group"> 
      <h1 class="grid_3"><a href="/">Benjamin Silas Rhodes</a></h1> 
      <nav class="grid_4"> 
        <ul> 
          <li><a href="/about.html">About</a></li> 
          <li><a href="/geek_notes.html">Geek Notes</a></li> 
          <li><a href="/projects.html" class="last">Projects</a></li> 
        </ul> 
      </nav> 
    </div> 
  </header> 


  <div style="background: #fff" class="group"> 
    <br class="clear"/>
<section id="distractions" class="container_10">
  <article>
    <section class="grid_3 group published_on">
      January 31, 2011
    </section>
    <section class="grid_7 group post">
      <h2 class="title">Rails Bookmarklets without jQuery</h2>
      <div class="content">
        <p>The purpose of this article is to explain how I created the bookmarklet for <a href="http://readingtime.me">readingtime.me</a>.  I wanted the bookmarklet to be as light and simple as possible. Simple also requires that no external libraries are required as well, hence the without jQuery part.</p>

<h2>Link Generation</h2>

<p>The first thing to do is create a piece of javascript that will load in the javascript file that you want to execute on the page.</p>

<div class="highlight"><pre><code class="js"><span class="c1">//bookmarklet.js</span>
<span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
<span class="nx">s</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;language&#39;</span><span class="p">,</span><span class="s1">&#39;javascript&#39;</span><span class="p">);</span>
<span class="nx">s</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">,</span><span class="s1">&#39;http://example.com/js/bookmarklet.js&#39;</span><span class="p">);</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span>
<span class="k">void</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</code></pre>
</div>


<p>I went with the most simple solution.  The above script simply injects a new script on the user's current page.  The browser will then automatically load that script.  Once that is complete you need to run that through something that will strip out all the new lines and bad characters.  I found a <a href="http://daringfireball.net/2007/03/javascript_bookmarklet_builder">script from daring fireball</a> that does just that.  Stick the output into a anchor tag and your good to go.</p>

<h2>Rails Javascript Generation</h2>

<p>I wanted to be able to render things inside my javascript file so I created a controller that had a single action bookmarklet.  They controller also set the layout to false so that it would only render the js file.</p>

<div class="highlight"><pre><code class="ruby"><span class="c1">#js_controller.rb</span>
<span class="k">class</span> <span class="nc">JsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">layout</span> <span class="kp">false</span>

  <span class="k">def</span> <span class="nf">bookmarklet</span> 
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1">#routes.rb</span>
<span class="n">get</span> <span class="s2">&quot;js/bookmarklet(.:format)&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;js#bookmarklet&quot;</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:bookmarklet</span>
</code></pre>
</div>


<p>Rails will take care of serving the proper file type with the format included in the route.  The view consists of a standard js.erb file listed bellow (excuse the extended long lines):</p>

<div class="highlight"><pre><code class="js"><span class="c1">//bookmarklet.js.erb</span>
<span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">function</span> <span class="nx">create_container</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">container</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">);</span>
    <span class="nx">container</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
    <span class="nx">container</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;%= escape_javascript(render( :partial =&gt; &quot;</span><span class="nx">shared</span><span class="o">/</span><span class="nx">ui</span><span class="s2">&quot;, :locals =&gt; {:api_key =&gt; params[:k]}))%&gt;&quot;</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">container</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">save_link</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">script</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;script&quot;</span><span class="p">);</span>
    <span class="nx">script</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;text/javascript&quot;</span><span class="p">;</span>
    <span class="nx">script</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s2">&quot;&lt;%= links_create_url(:format =&gt; &#39;js&#39;) %&gt;?callback=save_link_complete&amp;api_key=&lt;%= params[&quot;</span><span class="nx">api_key</span><span class="s2">&quot;] %&gt;&amp;link[url]=&quot;</span> <span class="o">+</span> <span class="nb">encodeURI</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">);</span>
    <span class="nx">script</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="s2">&quot;readingtime-loadJSONP&quot;</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">script</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="nx">create_container</span><span class="p">(</span><span class="s2">&quot;readingtime-container&quot;</span><span class="p">);</span>
  <span class="nx">save_link</span><span class="p">();</span>
<span class="p">})();</span>

<span class="kd">function</span> <span class="nx">save_link_complete</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">set_status</span><span class="p">(</span><span class="s2">&quot;&lt;%= escape_javascript(render(&quot;</span><span class="nx">shared</span><span class="o">/</span><span class="nx">saved</span><span class="s2">&quot;)) %&gt;&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">set_status</span><span class="p">(</span><span class="s2">&quot;&lt;%= escape_javascript(render(&quot;</span><span class="nx">shared</span><span class="o">/</span><span class="nx">error</span><span class="s2">&quot;)) %&gt;&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;readingtime-loadJSONP&quot;</span><span class="p">);</span>
  <span class="nx">s</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span>

  <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">close_container</span><span class="p">,</span> <span class="mi">750</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">set_status</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;readingtime-status&quot;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">content</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">close_container</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">container</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;readingtime-container&#39;</span><span class="p">);</span>
  <span class="nx">container</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
  <span class="nx">container</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">container</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>


<p>The first two functions create_container and save_link do the following.  Create container adds a new div to the user's page.  Within that div I render the content of a rails partial which contains the UI of the bookmarklet.</p>

<p>The next function save_link performs a JSONP style request.  We basically inject another script tag into the document and that script tag will perform a get request to our server.  Our server will then respond with a callback that has the arguments of the server's response.  This enables us to bypass any cross domain security violations.</p>

<p>After we receive the response from teh server our callback save_link_complete will be called and then we display that information to the user. After that we wait for 3/4 of a second then close the view.  We could do some fancy fade out or slide out but I wanted the bookmarklet to feel snappy and fast.</p>

<h2>Conclusions</h2>

<p>The goal was to create something that solves my bookmarklet problem in the simplest possible way.  I'm not a fan of over engineering things until they need to be. I believe I met this goal and the bookmarklet has been tested on Firefox, Chrome, Safari.</p>

<p>If you have any questions or improvements please email me.  I will be very happy to answer anything that I may have missed in this explanation or be wiling to change any errors that I may have produced. I hope you found this informative and I wish you the best of luck with your projects.</p>

      </div>
    </section>
  </article>
  <div class="grid_3">&nbsp;</div>
  <div class="grid_3" style="margin-bottom: 1em">
  
    <a href="/mac-like-text-editing-keybinds.html" title="previous post">Mac Like Text Editing Keybinds</a>
  
  </div>
  <div class="grid_4" style="text-align: right; margin-bottom: 1em">
  
    <a href="/on-finding-cofounders.html" title="next post">On Finding Co-founders</a>
  
  </div>
</section>
<br class="clear"/>  

  </div>
 
  <div id="cap" class="group"> 
    <div class="container_10 group"> 
      <div class="grid_10"> 
        &nbsp;
      </div> 
    </div> 
  </div> 
  
  <footer id="site" class="group"> 
    <div class="container_10 group"> 
      <div class="grid_3"> 
        <div class="distractions"> 
          <h4>Distractions</h4> 

          <div class="distraction">
            <a href="http://www.joelonsoftware.com/articles/FogCreekMBACurriculum.html">Reading List: Fog Creek Software Managment Training Program</a>
          </div>
          
          <div class="distraction">
            <a href="http://www.ted.com/talks/lang/eng/ken_robinson_changing_education_paradigms.html">Ken Robinson: Changing education paradigms</a>
          </div>

          <div class="distraction">
            <a href="http://www.ted.com/talks/thomas_thwaites_how_i_built_a_toaster_from_scratch.html">Thomas Thwaites: How I build a toaster</a>
          </div> 

          <div class="distraction">
            <a href="http://itunes.apple.com/podcast/global-trance-grooves-john/id301295540">Global Trances Grooves Podcast</a>
          </div>

          <div class="distraction">
            <a href="http://discovertrance.com">Discover Trance Raido</a>
          </div>

          <div class="distraction">
            <a href="http://www.youtube.com/user/HuskyStarcraft">Husky Starcraft</a>
          </div>

          <div class="distraction">
            <a href="http://coderloop.com/">Coderloop</a>
          </div>

          <div class="distraction">
            <a href="http://dribbble.com/">Dribbble</a>
          </div>

          <div class="distraction">
            <a href="http://day9tv.blip.tv/">Day9tv</a>
          </div>
          
          <div class="distraction">
            <a href="http://ww.reddit.com/">Reddit</a>
          </div>

          <div class="distraction">
            <a href="http://www.ted.com/">Ted</a>
          </div>
        </div> 
    </div> 

    <div class="grid_4"> 
      
      <div class="about"> 
        <h4>About</h4> 
        This site is where I keep my notes.  I try to post the things that frustrate me and inspire me. 
        <a href="/about.html" class="read_more"> Read more</a> 
      </div>

      <div class="projects"> 
        <h4>Currently Working On</h4> 
        Boxed mobile, mobile web hosting done right.
        <a href="http://boxedmobile.com/" class="read_more">http://boxedmobile.com</a> 
      </div>


      <div class="reading group"> 
        <h4>Currently Reading</h4> 
  
        <div style="float: left; width: 190px;"> 
        <em>Programing Clojure</em><br/> 
          Stuart Halloway
        </div> 
        <img src="/images/books/clojure.png" style="border: 5px solid #2f2f2f;" alt="Programing Clojure by Stuart Halloway"/> 
      </div>  
    </div> 

    <div class="grid_3"> 
      <div class="inspiration"> 
        <h4>Inspiration</h4> 
        <a href="http://www.ted.com/talks/denis_dutton_a_darwinian_theory_of_beauty.html">Denis Dutton: A Darwinian theory of beauty</a> 
      </div> 
      <div class="bookmarks"> 
        <h4>Stuff I Just Read</h4> 
        <ul id="readingtime"></ul>
        <p>Share what you are reading at: <a href="http://readingtime.me">readingtime.me</a></p>
      </div> 
    </div> 
  </div> 
</footer> 
<div id="endcap" class="group"> 
  <div class="container_10 group"> 
    <div class="grid_3"> 
      2010 Benjamin Silas Rhodes
    </div> 
  </div> 
</div> 
<script>
$(function() {
  var limit = 5;
  $.getJSON("http://readingtime.me/readers/4d43741f85cd402d2a000002/read.json?callback=?&limit=" + limit, function(data) {
    for(var i = 0; i < limit; i++) {
      $('<li><a href="' + data[i].url + '">' + data[i].url + '</a></li>').appendTo("#readingtime");
    }
  });
});
</script>
<script type="text/javascript"> 
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-12681877-1']);
    _gaq.push(['_trackPageview']);
 
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script> 
</body> 
</html>
